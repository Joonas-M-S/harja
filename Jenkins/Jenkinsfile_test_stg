properties([buildDiscarder(logRotator(artifactDaysToKeepStr: '',
        artifactNumToKeepStr: '',
        numToKeepStr: '2')),
            disableConcurrentBuilds(),
            disableResume(),
            pipelineTriggers([pollSCM('H/5 * * * *')])])

node {

    println "stg-test branch"

    def jenkinsinBuildNumber = currentBuild.number

    // Lisää mvn pathiin
    env.PATH = "${env.JENKINS_HOME}/tools/hudson.tasks.Maven_MavenInstallation/Maven_3.5.4/bin:${env.PATH}"

    if (muutosTapahtui) {
        dir('Harja') {
            // Tämä Checkout on sama kuin methods.checkoutHarja, mutta tämä pitää tehdä ennen, kuin tuota fileä voi ladata workspacesta
            checkout([poll: true,
                      scm : [$class                           : 'GitSCM',
                             branches                         : [[name: '*/test-stg']],
                             doGenerateSubmoduleConfigurations: false,
                             extensions                       : [[$class: 'CheckoutOption', timeout: 15],
                                                                 [$class: 'CloneOption', depth: 0, noTags: false, reference: '', shallow: true, timeout: 15]],
                             submoduleCfg                     : [],
                             userRemoteConfigs                : [[url: 'https://github.com/finnishtransportagency/harja.git']]]])

            def methods = load "Jenkins/skriptit/Tyokalut.groovy"
            def vars = load "Jenkins/skriptit/Vars.groovy"

            env.TESTI_BRANCH = true
            /*
             * TESTIKANNAN LUOMINEN
             */

            stage(vars.testikannanLuonti) {
                if (vars.testikannanLuontiAjetaan) {
                    methods.ajaTestikannanLuonti(vars.testikannanLuonti)
                }
            }

            /*
             * TESTIEN AJAMINEN JA JAR:IN LUOMINEN
             */

            stage(vars.jarJaTestit) {
                if (vars.jarJaTestitAjetaan) {
                    methods.ajaJarJaTestit(vars.jarJaTestit)
                }
            }

            /*
             * TESTISERVERIKANNAN LUOMINEN
             */

            stage(vars.testiserverinKannanLuonti) {
                if (vars.testiserverinKannanLuontiAjetaan) {
                    methods.ajaTestiserverinKanta(vars.testiserverinKannanLuonti)
                }
            }
        }

        dir('CI') {
            methods.checkoutCI()
            /*
             * TESTISERVERIAPPIKSEN DEPLOYAAMINEN
             */

            stage(vars.testiserverinAppLuonti) {
                if (vars.testiserverinAppLuontiAjetaan) {
                    methods.ajaTestiserverinApp(vars.testiserverinAppLuonti, jenkinsinBuildNumber)
                }
            }
        }

        dir('E2E') {
            methods.checkoutE2E()
            /*
             * E2E TESTIT
             */
            stage(vars.e2eTestit) {
                if (vars.e2eTestitAjetaan) {
                    methods.ajaE2ETestit(vars.e2eTestit)
                }
            }
        }

        dir('Harja') {
            /*
             * STAGESERVERIKANNAN LUOMINEN
             */

            stage(vars.stagingserverinKannanLuonti) {
                if (vars.stagingserverinKannanLuontiAjetaan) {
                    methods.ajaStagingserverinKanta(vars.stagingserverinKannanLuonti)
                }
            }
        }

        dir('CI') {
            /*
             * STAGING SERVERIAPPIKSEN DEPLOYAAMINEN
             */

            stage(vars.stagingserverinAppLuonti) {
                if (vars.stagingserverinAppLuontiAjetaan) {
                    methods.ajaStagingserverinApp(vars.stagingserverinAppLuonti, jenkinsinBuildNumber)
                }
            }
        }

        /*
         * SIIVOTAAN WORKSPACE
         */

        stage('Siivoa workspace') {
           cleanWs()
        }
    }
}