//import java.text.SimpleDateFormat

node {
  checkout scm;
  // Lisää mvn pathiin
  env.PATH = "${env.JENKINS_HOME}/tools/hudson.tasks.Maven_MavenInstallation/Maven_3.5.4/bin:${env.PATH}"

  // Jos on tarvesta tarkastaa, että onko oikeasti kommitoitu mitäään viime pollauksesta, niin unkommentoi nämä
  // def viimeisinMuutosRiviS = sh([script: "git log -n 1 --date=iso8601 | grep Date",
  //                                returnStdout: true])
  // def viimeisinMuutosS = (viimeisinMuutosRiviS =~ /[-0-9]+ [:0-9]*/)[0]
  // SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss")
  // def viimeisinMuutosD = sdf.parse(viimeisinMuutosS)
  // def aikaNytD = new Date()
  // def aika5minSitten = new Date(aikaNytD.getTime() - 5*60*1000)
  // if (aika5minSitten.before(viimeisinMuutosD)) {
    def testikannanPystytysOnnistui = sh([script: "sh Jenkins/skriptit/testitietokanta.sh",
                                          returnStatus: true])
    if (testikannanPystytysOnnistui == 0) {
      def tuotantoBuildJaTestit = sh([script: "lein tuotanto",
                                      returnStatus: true])
      archiveArtifacts([artifacts: 'target/harja-*-standalone.jar, doc/*'])
      if (tuotantoBuildJaTestit == 0) {
        sh "echo Kaikki hyvin"
      } else {
        error([message: "'lein tuotanto' epäonnistui"])
      }
    } else {
      error([message: "Testikannan pystytys epäonnistui."])
    }
  //}
  // Migraatiot testipannulle
  // Nightly deploy
  // Harja-e2e
    // build env
      // Xvfb
      // abort if stuck 20min tries 2
    // build
      // do clean, compile, test2junit
    // After
      // JUnit
      // Retry 5min delay, 3 failed tries
      // Slack on fail and back to normal
  // harja-staging-db
  // harja-staging-app
    // General
      // keep builds for 7 days
  // harja-prod-db
  // harja-prod-app
    // ajetaan?
      // 7am arkisin
    // slack kun build start, faiure, success, back to normal
  // API Docsit pitää laittaa jossain väli

}
